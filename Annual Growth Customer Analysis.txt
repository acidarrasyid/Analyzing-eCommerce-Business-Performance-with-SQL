with cal_mau as( 
select year, round(avg(mau), 2) as avg_mau
from
(	select
		date_part('year', od.order_purchase_timestamp) as year,
		date_part('month', od.order_purchase_timestamp) as month,
		count (distinct cd.customer_unique_id) as mau
	from orders_dataset as od
	join customers_dataset as cd on od.customer_id = cd.customer_id
	group by 1,2
) as tmp
group by 1
),
cal_new_cust as( 
select date_part ('year', first_time_purchase) as year,
count (1) as new_customer
from
(	select customer_unique_id,
	min (od.order_purchase_timestamp) as first_time_purchase
	from orders_dataset as od
	join customers_dataset as cd on cd.customer_id = od.customer_id
	group by 1
) as tmp
group by 1
),
cal_repeat as (
select year,
count (distinct customer_unique_id) as repeating_customer
from
(	select date_part('year', od.order_purchase_timestamp) as year, cd.customer_unique_id,
	count (1) as purchase_frequency
	from orders_dataset as od
	join customers_dataset as cd on cd.customer_id = od.customer_id
	group by 1,2
	having count (1) > 1
) as tmp
group by 1
),
cal_aov as(
select year, round (avg(purchase_frequency),3) as avg_order_customer
from
(	select date_part('year', od.order_purchase_timestamp) as year, cd.customer_unique_id,
	count (1) as purchase_frequency
	from orders_dataset as od
	join customers_dataset as cd on cd.customer_id = od.customer_id
	group by 1,2
) as tmp
group by 1
)

select
	mau.year,
	mau.avg_mau,
	newc.new_customer,
	rep.repeating_customer,
	aov.avg_order_customer
from cal_mau as mau
join cal_new_cust as newc on mau.year = newc.year
join cal_repeat as rep on rep.year = mau.year
join cal_aov as aov on aov.year = mau.year