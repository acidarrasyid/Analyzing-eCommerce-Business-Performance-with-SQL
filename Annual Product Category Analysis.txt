create table total_revenue_dataset as
select date_part('year', od.order_purchase_timestamp) as year,
sum (revenue_per_order) as revenue
from
(	select order_id,
	sum (price) as revenue_per_order
	from order_item_dataset
	group by 1
) as tmp
join orders_dataset as od on tmp.order_id = od.order_id
where od.order_status = 'delivered'
group by 1;

create table cancel_order_dataset as
select date_part('year', order_purchase_timestamp) as year,
count (1) as canceled_order
from orders_dataset
where order_status = 'canceled'
group by 1;

create table product_top_category_dataset as
select year, product_category_name, revenue
from
(	select 	date_part ('year', od.order_purchase_timestamp) as year,
			pd.product_category_name,
			sum (oid.price + oid.freight_value) as revenue,
			rank() over (partition by date_part ('year', od.order_purchase_timestamp) order by sum (oid.freight_value) desc) as rangking
	from order_item_dataset as oid
	join orders_dataset as od on od.order_id = oid.order_id
	join product_dataset as pd on pd.product_id = oid.product_id
	where od.order_status = 'delivered'
	group by 1,2
	order by 1
) as tmp
where rangking = 1;

create table product_top_cancel_dataset as
select year, product_category_name, num_canceled
from
(	select 	date_part ('year', od.order_purchase_timestamp) as year,
			pd.product_category_name,
			count (1) as num_canceled,
			rank() over (partition by date_part ('year', od.order_purchase_timestamp) order by count (1) desc) as rangking
	from order_item_dataset as oid
	join orders_dataset as od on od.order_id = oid.order_id
	join product_dataset as pd on pd.product_id = oid.product_id
	where od.order_status = 'canceled'
	group by 1,2
) as tmp
where rangking = 1;

select
	ptcd.year,
	ptcd.product_category_name as top_product_revenue,
	ptcd.revenue as category_revenue,
	trd.revenue as total_revenue,
	ptcnd.product_category_name as cancel_product_category,
	ptcnd.num_canceled as category_num_cancel,
	cod.canceled_order as total_cancel
from product_top_category_dataset as ptcd
join total_revenue_dataset as trd on ptcd.year = trd.year
join product_top_cancel_dataset as ptcnd on ptcd.year = ptcnd.year
join cancel_order_dataset as cod on cod.year = ptcd.year;
